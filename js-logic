// ãƒ‡ãƒãƒƒã‚°ç”¨ã«åˆ©ç”¨å¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
console.log('THREE:', THREE);
console.log('THREE.FBXLoader:', THREE.FBXLoader);
console.log('THREE.STLLoader:', THREE.STLLoader);

// Three.jsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‚ç…§ã‚’ç¢ºèªï¼ˆr128å‘ã‘ï¼‰
const FBXLoader = THREE.FBXLoader;
const STLLoader = THREE.STLLoader;
const EffectComposer = THREE.EffectComposer;
const RenderPass = THREE.RenderPass;
const ShaderPass = THREE.ShaderPass;
const UnrealBloomPass = THREE.UnrealBloomPass;

// script.js - ãƒ‘ãƒ¼ãƒˆ1: åŸºæœ¬è¨­å®š
const DEBUG_LEVEL = 2; // 0=ç„¡åŠ¹, 1=ã‚¨ãƒ©ãƒ¼ã®ã¿, 2=è­¦å‘Šã‚‚è¡¨ç¤º, 3=å…¨ã¦è¡¨ç¤º

// ãƒ‡ãƒãƒƒã‚°é–¢æ•°
function log(level, message, data) {
  if (level <= DEBUG_LEVEL) {
    const prefix = level === 1 ? 'âŒ ERROR: ' : level === 2 ? 'âš ï¸ WARNING: ' : 'ğŸ” DEBUG: ';
    console.log(prefix + message, data !== undefined ? data : '');
  }
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éš ã™
function hideLoading() {
  try {
    const loadingScreen = document.querySelector('.loading-screen');
    if (loadingScreen) {
      loadingScreen.classList.add('hidden');
      log(3, 'ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
    }
  } catch (error) {
    log(1, 'ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éš ã™éš›ã«ã‚¨ãƒ©ãƒ¼', error);
  }
}

// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’çµ‚äº†ï¼ˆ30ç§’ï¼‰
setTimeout(hideLoading, 30000);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let scene, camera, renderer, composer, ringMesh, floorMesh;
let raycaster, mouse;
let isRingHovered = false;
let isDragging = false;
let previousMousePosition = { x: 0, y: 0 };
let canvasElement;
let modelLoadingFailed = false; // ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰å¤±æ•—ãƒ•ãƒ©ã‚°

// å®šæ•°å®šç¾©ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã«
const FLOOR_HEIGHT = -30;
const FLOOR_OFFSET_Z = 30;

// ãƒ‡ãƒã‚¤ã‚¹ã‚µã‚¤ã‚ºã«å¿œã˜ãŸå€¤ã‚’è¨­å®šã™ã‚‹é–¢æ•°
function getResponsiveValues() {
  const isMobile = window.innerWidth < 768;
  
  return {
    // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒªãƒ³ã‚°ã‚’ã‚ˆã‚Šä¸Šæ–¹ã«é…ç½®ã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯ã‚„ã‚„ä¸‹ã«
    RING_HEIGHT: isMobile ? 10 : -5,
    // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚«ãƒ¡ãƒ©ã‚’ã‚ˆã‚Šé«˜ãã€ã‚„ã‚„è¿‘ã¥ã‘ã¦
    CAMERA_HEIGHT: isMobile ? 45 : 35,
    CAMERA_DISTANCE: isMobile ? 85 : 90
  };
}

// ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å€¤ã®åˆæœŸè¨­å®š
let { RING_HEIGHT, CAMERA_HEIGHT, CAMERA_DISTANCE } = getResponsiveValues();

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
window.addEventListener('error', function(event) {
  log(1, `ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼: ${event.message} at ${event.filename}:${event.lineno}`);
  
  // WebGLã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸã¨è¦‹ãªã™
  if (event.message && event.message.includes('WebGL')) {
    modelLoadingFailed = true;
  }
});

// script.js - ãƒ‘ãƒ¼ãƒˆ2: åˆæœŸåŒ–ã¨ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼è¨­å®š
function init() {
  log(3, 'init() é–‹å§‹');
  try {
    canvasElement = document.getElementById('canvas');
    if (!canvasElement) {
      throw new Error('canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    // ã‚·ãƒ¼ãƒ³ã®ä½œæˆ
    scene = new THREE.Scene();
    
    // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªå€¤ã‚’å–å¾—
    const responsiveValues = getResponsiveValues();
    RING_HEIGHT = responsiveValues.RING_HEIGHT;
    CAMERA_HEIGHT = responsiveValues.CAMERA_HEIGHT;
    CAMERA_DISTANCE = responsiveValues.CAMERA_DISTANCE;
    
    // ã‚«ãƒ¡ãƒ©ã®è¨­å®š
    camera = new THREE.PerspectiveCamera(35, window.innerWidth/window.innerHeight, 0.1, 2000);
    camera.position.set(0, CAMERA_HEIGHT, CAMERA_DISTANCE);
    camera.lookAt(0, RING_HEIGHT, 0);
    
    // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®è¨­å®š
    try {
      renderer = new THREE.WebGLRenderer({ 
        antialias: true,
        powerPreference: "high-performance",
        alpha: true // é€æ˜èƒŒæ™¯ã‚’è¨±å¯
      });
    } catch (error) {
      log(1, 'WebGLRendererä½œæˆå¤±æ•—', error);
      return;
    }
    
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    
    // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®ã‚«ãƒ©ãƒ¼ã‚¹ãƒšãƒ¼ã‚¹è¨­å®šï¼ˆr128å‘ã‘ï¼‰
    if (THREE.LinearEncoding !== undefined) {
      renderer.outputEncoding = THREE.sRGBEncoding;
    } else if (renderer.outputColorSpace !== undefined) {
      renderer.outputColorSpace = THREE.SRGBColorSpace;
    }
    
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 0.9;
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    canvasElement.appendChild(renderer.domElement);
    
    // ãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼
    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();
    
    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒãƒ¼ã‚¶ãƒ¼
    try {
      console.log('EffectComposer:', typeof THREE.EffectComposer);
      console.log('RenderPass:', typeof THREE.RenderPass);
      console.log('UnrealBloomPass:', typeof THREE.UnrealBloomPass);

      composer = new THREE.EffectComposer(renderer);
      const renderPass = new THREE.RenderPass(scene, camera);
      composer.addPass(renderPass);
      
      const bloom = new THREE.UnrealBloomPass(
        new THREE.Vector2(window.innerWidth, window.innerHeight),
        0.15, 0.8, 0.35
      );
      composer.addPass(bloom);
    } catch (error) {
      log(1, 'ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒãƒ¼ã‚¶ãƒ¼ä½œæˆå¤±æ•—', error);
      console.error(error);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      composer = {
        render: function() { 
          if (renderer) renderer.render(scene, camera); 
        },
        setSize: function(w, h) { /* ä½•ã‚‚ã—ãªã„ */ }
      };
    }
    
    // ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ­ãƒ¼ãƒ€ãƒ¼
    const textureLoader = new THREE.TextureLoader();
    
    // ãƒ‘ãƒãƒ©ãƒã®ãƒ­ãƒ¼ãƒ‰
    loadRoomBackground(textureLoader);
    
    // æœ¨ç›®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã®ãƒ­ãƒ¼ãƒ‰
    textureLoader.load(
      'https://threejs.org/examples/textures/hardwood2_diffuse.jpg',
      function(texture) {
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;
        texture.repeat.set(4, 4);
        
        createWoodenFloor(texture);
        setupLighting();
        
        // ã‚«ãƒ©ãƒ¼ã‚¹ã‚¦ã‚©ãƒƒãƒã®ä½œæˆï¼ˆãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å‰ã«ä½œæˆï¼‰
        createColorSwatches();
        
        // FBXãƒ­ãƒ¼ãƒ‰è©¦è¡Œï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»•çµ„ã¿ä»˜ãï¼‰
        tryLoadModelWithFallback();
      },
      undefined,
      function(error) {
        log(1, 'æœ¨ç›®ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ­ãƒ¼ãƒ‰å¤±æ•—', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ†ã‚¯ã‚¹ãƒãƒ£ãªã—ã§ç¶šè¡Œï¼‰
        createWoodenFloor();
        setupLighting();
        createColorSwatches();
        tryLoadModelWithFallback();
      }
    );
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    setupEventListeners();
    
  } catch (error) {
    log(1, 'init()ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', error);
    hideLoading();
  }
}

// script.js - ãƒ‘ãƒ¼ãƒˆ3: èƒŒæ™¯ã€ç…§æ˜ã€åºŠã®è¨­å®š
function loadRoomBackground(textureLoader) {
  try {
    textureLoader.load(
      'https://images.unsplash.com/photo-1600210492493-0946911123ea?q=80&w=2874&auto=format&fit=crop&ixlib=rb-4.0.3',
      function(texture) {
        try {
          const geometry = new THREE.SphereGeometry(500, 60, 40);
          geometry.scale(-1, 1, 1);
          
          const material = new THREE.MeshBasicMaterial({
            map: texture,
            side: THREE.DoubleSide
          });
          
          const mesh = new THREE.Mesh(geometry, material);
          scene.add(mesh);
          
          // ç’°å¢ƒãƒãƒƒãƒ—ã¨ã—ã¦ã‚‚è¨­å®š
          scene.environment = texture;
        } catch (error) {
          log(1, 'èƒŒæ™¯ãƒ‘ãƒãƒ©ãƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', error);
        }
      },
      undefined,
      function(error) {
        log(1, 'èƒŒæ™¯ãƒ‘ãƒãƒ©ãƒãƒ­ãƒ¼ãƒ‰å¤±æ•—', error);
        scene.background = new THREE.Color(0xf6f6f6);
      }
    );
  } catch (error) {
    log(1, 'èƒŒæ™¯ãƒ‘ãƒãƒ©ãƒãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼', error);
    scene.background = new THREE.Color(0xf6f6f6);
  }
}

function setupLighting() {
  try {
    // ç’°å¢ƒå…‰
    const ambientLight = new THREE.AmbientLight(0xf5f2eb, 0.5);
    scene.add(ambientLight);
    
    // ãƒ¡ã‚¤ãƒ³ãƒ©ã‚¤ãƒˆ
    const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
    mainLight.position.set(50, 80, 50);
    mainLight.castShadow = true;
    
    // ã‚·ãƒ£ãƒ‰ã‚¦ãƒãƒƒãƒ—è¨­å®š
    mainLight.shadow.mapSize.width = 1024;
    mainLight.shadow.mapSize.height = 1024;
    mainLight.shadow.camera.near = 0.5;
    mainLight.shadow.camera.far = 500;
    mainLight.shadow.camera.left = -100;
    mainLight.shadow.camera.right = 100;
    mainLight.shadow.camera.top = 100;
    mainLight.shadow.camera.bottom = -100;
    mainLight.shadow.bias = -0.001;
    mainLight.shadow.normalBias = 0.02;
    scene.add(mainLight);
    
    // ãƒ•ã‚£ãƒ«ãƒ©ã‚¤ãƒˆ
    const fillLight = new THREE.DirectionalLight(0xf5f2eb, 0.4);
    fillLight.position.set(-80, 20, 60);
    scene.add(fillLight);
    
    // ãƒãƒƒã‚¯ãƒ©ã‚¤ãƒˆ
    const backLight = new THREE.DirectionalLight(0xf8f8ff, 0.2);
    backLight.position.set(0, 40, -80);
    scene.add(backLight);
    
    // ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆ
    const spotLight = new THREE.SpotLight(0xffffff, 0.8);
    spotLight.position.set(0, 100, 0);
    spotLight.angle = Math.PI / 6;
    spotLight.penumbra = 0.2;
    spotLight.decay = 2;
    spotLight.distance = 200;
    spotLight.castShadow = true;
    scene.add(spotLight);
  } catch (error) {
    log(1, 'ç…§æ˜ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', error);
  }
}

function createWoodenFloor(texture) {
  try {
    const floorGeometry = new THREE.PlaneGeometry(300, 300);
    const floorMaterial = new THREE.MeshStandardMaterial({
      map: texture || null,
      color: texture ? 0xffffff : 0xd2b48c,
      metalness: 0.1,
      roughness: 0.8,
    });
    floorMesh = new THREE.Mesh(floorGeometry, floorMaterial);
    floorMesh.rotation.x = -Math.PI / 2;
    floorMesh.position.set(0, FLOOR_HEIGHT, FLOOR_OFFSET_Z);
    floorMesh.receiveShadow = true;
    scene.add(floorMesh);
  } catch (error) {
    log(1, 'æœ¨è£½åºŠä½œæˆã‚¨ãƒ©ãƒ¼', error);
  }
}

// script.js - ãƒ‘ãƒ¼ãƒˆ4: ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ€ãƒ¼ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ (è¦–ç‚¹èª¿æ•´ç‰ˆ)
// ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
let modelLoaded = false;

// FBXãƒ•ã‚¡ã‚¤ãƒ«/STLãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œã—ã€å¿…è¦ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹
function tryLoadModelWithFallback() {
  try {
    // ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸãƒ­ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    modelLoaded = false;
    modelLoadingFailed = false;
    
    // ã¾ãšFBXãƒ¢ãƒ‡ãƒ«ã‚’è©¦ã™ (rawã®URLã‚’ä½¿ç”¨)
    loadFBXModel('https://raw.githubusercontent.com/asachi/lieun/main/TWRINGfbx.fbx');
    
    // ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ä¸€å®šæ™‚é–“å¾Œã«STLãƒ¢ãƒ‡ãƒ«ã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç¢ºèª
    setTimeout(function() {
      if (!modelLoaded && ((document.querySelector('.loading-screen') && 
          !document.querySelector('.loading-screen.hidden')) || modelLoadingFailed)) {
        log(2, "FBXãƒ­ãƒ¼ãƒ‰ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯å¤±æ•—ã€STLãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™");
        loadSTLModel('https://raw.githubusercontent.com/asachi/lieun/main/ring_data_0509.stl');
      }
    }, 8000); // 8ç§’å¾Œã«ãƒã‚§ãƒƒã‚¯
  } catch (error) {
    log(1, "ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å‡¦ç†ã‚¨ãƒ©ãƒ¼", error);
    if (!modelLoaded) {
      loadSTLModel('https://raw.githubusercontent.com/asachi/lieun/main/ring_data_0509.stl');
    }
  }
}

// FBXãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€é–¢æ•° (ãƒ†ã‚¯ã‚¹ãƒãƒ£å¯¾å¿œãƒ»ã‚µã‚¤ã‚ºèª¿æ•´ç‰ˆ)
function loadFBXModel(url) {
  log(2, 'FBXãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ' + url);
  
  const loadingScreen = document.querySelector('.loading-screen');
  
  try {
    console.log('FBXLoaderã®å‹:', typeof THREE.FBXLoader);
    console.log('fflate available:', typeof fflate !== 'undefined');
    console.log('Zlib.Inflate available:', typeof window.Zlib?.Inflate !== 'undefined');
    
    // FBXLoader ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if (typeof THREE.FBXLoader !== 'function') {
      throw new Error('FBXLoaderãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
    }
    
    // fflateã®ãƒã‚§ãƒƒã‚¯
    if (typeof fflate === 'undefined') {
      throw new Error('fflate ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚FBXã®èª­ã¿è¾¼ã¿ã«ã¯å¿…é ˆã§ã™ã€‚');
    }
    
    // ãƒ­ãƒ¼ãƒ€ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    const loader = new THREE.FBXLoader();
    console.log('FBXLoader ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
    
    loader.setCrossOrigin('anonymous');
    
    // ãƒ¢ãƒ‡ãƒ«ã®URLã‚’è¨­å®š
    const modelUrl = url;
    
    loader.load(
      modelUrl,
      function(object) {
        // ã™ã§ã«åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ãŒãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (modelLoaded) {
          log(2, 'FBXãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ãŸãŒã€æ—¢ã«åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãŸã‚ç„¡è¦–ã—ã¾ã™');
          return;
        }
        
        log(2, 'FBXãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å®Œäº†');
        try {
          // ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸãƒ•ãƒ©ã‚°ã‚’è¨­å®š
          modelLoaded = true;
          
          // ãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆè©³ç´°è¡¨ç¤ºï¼‰
          console.log("FBXãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—:", object.type);
          console.log("FBXãƒ¢ãƒ‡ãƒ«å­è¦ç´ æ•°:", object.children ? object.children.length : 0);
          
          // å¤ã„ãƒªãƒ³ã‚°ã‚’å‰Šé™¤
          if (ringMesh) {
            scene.remove(ringMesh);
          }
          
          // STLã¨åŒã˜ã‚µã‚¤ã‚ºã«è¨­å®šï¼ˆå›ºå®šã‚µã‚¤ã‚ºï¼‰
          object.scale.set(0.8, 0.8, 0.8);
          object.position.set(0, RING_HEIGHT, 0);
          
          // ãƒªãƒ³ã‚°ãŒæ°´å¹³ã«ãªã‚‹ã‚ˆã†ã«å›è»¢ã‚’ä¿®æ­£
          object.rotation.set(Math.PI/2, Math.PI, 0);
          
          // ã‚«ãƒ¡ãƒ©ä½ç½®ã¯å…ƒã®ã¾ã¾ç¶­æŒ
          camera.position.set(0, CAMERA_HEIGHT, CAMERA_DISTANCE);
          camera.lookAt(0, RING_HEIGHT, 0);
          
          // ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ä¿æŒã™ã‚‹ãŸã‚å…ƒã®ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’ä½¿ç”¨ã—ã€å¿…è¦ãªè¨­å®šã ã‘è¿½åŠ 
          object.traverse(function(child) {
            if (child.isMesh) {
              // å…ƒã®ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’ä¿æŒ
              const origMaterial = child.material;
              
              // ãƒãƒ†ãƒªã‚¢ãƒ«ãŒé…åˆ—ã®å ´åˆ
              if (Array.isArray(origMaterial)) {
                origMaterial.forEach(function(mat) {
                  // ãƒ†ã‚¯ã‚¹ãƒãƒ£å‡¦ç†
                  if (mat.map) {
                    mat.map.encoding = THREE.sRGBEncoding || THREE.SRGBColorSpace;
                    mat.map.needsUpdate = true;
                  }
                  
                  // å¿…è¦ãªè¨­å®šã®ã¿è¿½åŠ 
                  mat.envMapIntensity = 1.0;
                  mat.needsUpdate = true;
                });
              } 
              // å˜ä¸€ãƒãƒ†ãƒªã‚¢ãƒ«ã®å ´åˆ
              else if (origMaterial) {
                // ãƒ†ã‚¯ã‚¹ãƒãƒ£ãŒã‚ã‚‹å ´åˆã¯ä¿æŒ
                if (origMaterial.map) {
                  origMaterial.map.encoding = THREE.sRGBEncoding || THREE.SRGBColorSpace;
                  origMaterial.map.needsUpdate = true;
                  origMaterial.envMapIntensity = 1.0;
                  origMaterial.needsUpdate = true;
                }
                // ãƒ†ã‚¯ã‚¹ãƒãƒ£ãŒãªã„å ´åˆã¯æ¨™æº–ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’é©ç”¨
                else {
                  child.material = new THREE.MeshStandardMaterial({
                    color: origMaterial.color || 0xffffff,
                    metalness: 0.7,
                    roughness: 0.3,
                    envMapIntensity: 1.0
                  });
                }
              }
              
              // å½±ã®è¨­å®š
              child.castShadow = true;
              child.receiveShadow = true;
            }
          });
          
          // ãƒªãƒ³ã‚°ãƒ¡ãƒƒã‚·ãƒ¥ã¨ã—ã¦å‚ç…§
          ringMesh = object;
          scene.add(object);
          
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ¢ãƒ‡ãƒ«ã‚’å°‘ã—å›è»¢ã•ã›ã‚‹ï¼‰
          gsap.from(object.rotation, {
            y: object.rotation.y + Math.PI*2,
            duration: 1.5,
            ease: 'expo.out'
          });
          
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
          if (loadingScreen) {
            loadingScreen.classList.add('hidden');
          }
          
          // å¿µã®ãŸã‚ã‚·ãƒ¼ãƒ³ã‚’å¼·åˆ¶æ›´æ–°
          renderer.render(scene, camera);
        } catch (error) {
          log(1, 'FBXãƒ¢ãƒ‡ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
          modelLoadingFailed = true;
          modelLoaded = false; // ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ã‚’å¤±æ•—ã¨ãƒãƒ¼ã‚¯
          hideLoading();
        }
      },
      // é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      function(xhr) {
        if (xhr.total > 0) {
          const percent = xhr.loaded / xhr.total * 100;
          log(3, `FBXãƒ­ãƒ¼ãƒ‰é€²æ—: ${percent.toFixed(1)}%`);
        }
      },
      // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      function(error) {
        log(1, 'FBXãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å¤±æ•—', error);
        console.error(error);
        modelLoadingFailed = true;
        hideLoading();
      }
    );
  } catch (error) {
    log(1, 'FBXãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
    console.error(error);
    modelLoadingFailed = true;
    hideLoading();
  }
}

// STLãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
function loadSTLModel(url) {
  log(2, 'STLãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ' + url);
  
  const loadingScreen = document.querySelector('.loading-screen');
  
  try {
    // ã™ã§ã«åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ãŒãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (modelLoaded) {
      log(2, 'STLãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—: æ—¢ã«åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    console.log('STLLoaderã®å‹:', typeof THREE.STLLoader);
    
    // STLLoader ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if (typeof THREE.STLLoader !== 'function') {
      throw new Error('STLLoaderãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    // ãƒ­ãƒ¼ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    const loader = new THREE.STLLoader();
    console.log('STLLoader ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
    
    loader.setCrossOrigin('anonymous');
    
    // ãƒ¢ãƒ‡ãƒ«ã®URLã‚’è¨­å®š
    const modelUrl = url;
    
    loader.load(
      modelUrl,
      function(geometry) {
        // ã™ã§ã«åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ãŒãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (modelLoaded) {
          log(2, 'STLãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ãŸãŒã€æ—¢ã«åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãŸã‚ç„¡è¦–ã—ã¾ã™');
          return;
        }
        
        log(2, 'STLãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å®Œäº†');
        try {
          // ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸãƒ•ãƒ©ã‚°ã‚’è¨­å®š
          modelLoaded = true;
          
          geometry.center();
          geometry.computeVertexNormals();
          
          // ãƒãƒ†ãƒªã‚¢ãƒ«
          const material = new THREE.MeshStandardMaterial({
            color: 0xffffff,
            metalness: 0.7,
            roughness: 0.2,
            envMapIntensity: 2.0
          });
          
          // å¤ã„ãƒ¡ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
          if (ringMesh) {
            scene.remove(ringMesh);
          }
          
          // æ–°ã—ã„ãƒ¡ãƒƒã‚·ãƒ¥ã‚’ä½œæˆ
          ringMesh = new THREE.Mesh(geometry, material);
          ringMesh.castShadow = true;
          ringMesh.receiveShadow = true;
          ringMesh.scale.set(0.8, 0.8, 0.8);
          ringMesh.position.y = RING_HEIGHT;
          
          // ãƒªãƒ³ã‚°ãŒæ°´å¹³ã«ãªã‚‹ã‚ˆã†ã«å›è»¢
          ringMesh.rotation.set(Math.PI/2, 0, 0);
          
          // ã‚«ãƒ¡ãƒ©ä½ç½®ã¯å…ƒã®ã¾ã¾
          camera.position.set(0, CAMERA_HEIGHT, CAMERA_DISTANCE);
          camera.lookAt(0, RING_HEIGHT, 0);
          
          scene.add(ringMesh);
          
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
          gsap.from(ringMesh.rotation, { 
            y: Math.PI*2, 
            duration: 2.0, 
            ease: 'expo.out' 
          });
          
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
          if (loadingScreen) {
            loadingScreen.classList.add('hidden');
          }
        } catch (error) {
          log(1, 'STLãƒ¢ãƒ‡ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
          modelLoaded = false; // ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ã‚’å¤±æ•—ã¨ãƒãƒ¼ã‚¯
          hideLoading();
          // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
          createPlaceholderRing();
        }
      },
      function(xhr) {
        if (xhr.total > 0) {
          const percent = xhr.loaded / xhr.total * 100;
          log(3, `STLãƒ­ãƒ¼ãƒ‰é€²æ—: ${percent.toFixed(1)}%`);
        }
      },
      function(error) {
        log(1, 'STLãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å¤±æ•—', error);
        console.error(error);
        hideLoading();
        // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
        createPlaceholderRing();
      }
    );
  } catch (error) {
    log(1, 'STLãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
    console.error(error);
    hideLoading();
    // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
    createPlaceholderRing();
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒªãƒ³ã‚°
function createPlaceholderRing() {
  log(2, 'ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒªãƒ³ã‚°ä½œæˆé–‹å§‹');
  try {
    // ã™ã§ã«åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ãŒãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (modelLoaded) {
      log(2, 'ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒªãƒ³ã‚°ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—: æ—¢ã«åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    // ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    modelLoaded = true;
    
    const placeholderGeo = new THREE.TorusGeometry(40, 6, 64, 100);
    const placeholderMat = new THREE.MeshStandardMaterial({ 
      color: 0xffffff,
      metalness: 0.7, 
      roughness: 0.2,
      envMapIntensity: 1.5
    });
    ringMesh = new THREE.Mesh(placeholderGeo, placeholderMat);
    ringMesh.castShadow = true;
    ringMesh.receiveShadow = true;
    ringMesh.position.y = RING_HEIGHT;
    
    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒªãƒ³ã‚°ã‚‚æ°´å¹³ã«è¡¨ç¤º
    ringMesh.rotation.set(Math.PI/2, 0, 0);
    
    scene.add(ringMesh);
    log(3, 'ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒªãƒ³ã‚°ä½œæˆå®Œäº†');
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼å›å¾©æ™‚ï¼‰
    hideLoading();
  } catch (error) {
    log(1, 'ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒªãƒ³ã‚°ä½œæˆã‚¨ãƒ©ãƒ¼', error);
  }
}

// script.js - ãƒ‘ãƒ¼ãƒˆ5: ã‚«ãƒ©ãƒ¼ã‚¹ã‚¦ã‚©ãƒƒãƒã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
function createColorSwatches() {
  try {
    const colors = [
      '#888888', // ã‚·ãƒ«ãƒãƒ¼
      '#ffffff', // ãƒ›ãƒ¯ã‚¤ãƒˆ
      '#FFD700', // ã‚´ãƒ¼ãƒ«ãƒ‰
      '#1d1d1d', // ã‚¹ãƒšãƒ¼ã‚¹ã‚°ãƒ¬ã‚¤
      '#ffb6c1'  // ãƒ”ãƒ³ã‚¯
    ];
    
    const swatches = document.getElementById('swatches');
    if (!swatches) {
      throw new Error('swatchesè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    // æ—¢å­˜ã®å­è¦ç´ ã‚’ã‚¯ãƒªã‚¢
    while (swatches.firstChild) {
      swatches.removeChild(swatches.firstChild);
    }
    
    colors.forEach((c, i) => {
      const btn = document.createElement('button');
      btn.style.background = c;
      if (c === '#1d1d1d') {
        btn.style.boxShadow = 'inset 0 0 0 1px rgba(255,255,255,0.2)';
      }
      
      // ãƒ›ãƒ¯ã‚¤ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠ
      if (i === 1) btn.classList.add('selected');
      
      const changeColor = function(event) {
        if (event.type === 'touchstart') {
          event.preventDefault();
        }
        
        // é¸æŠçŠ¶æ…‹ã®æ›´æ–°
        document.querySelectorAll('#swatches button').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        
        try {
          const col = new THREE.Color(c);
          
          if (ringMesh) {
            // FBXãƒ¢ãƒ‡ãƒ«ã®å ´åˆã€éšå±¤ã‚’èµ°æŸ»
            if (ringMesh.traverse) {
              ringMesh.traverse(function(child) {
                if (child.isMesh) {
                  
                  // ãƒãƒ†ãƒªã‚¢ãƒ«è¨­å®š
                  let metalness = 0.9, roughness = 0.1;
                  if (c === '#FFD700') { // ã‚´ãƒ¼ãƒ«ãƒ‰
                    metalness = 0.95; roughness = 0.05;
                  } else if (c === '#ffffff') { // ãƒ›ãƒ¯ã‚¤ãƒˆ
                    metalness = 0.7; roughness = 0.2;
                  } else if (c === '#1d1d1d') { // ã‚¹ãƒšãƒ¼ã‚¹ã‚°ãƒ¬ã‚¤
                    metalness = 0.8; roughness = 0.15;
                  } else if (c === '#ffb6c1') { // ãƒ”ãƒ³ã‚¯
                    metalness = 0.85; roughness = 0.1;
                  }
                  
                  // é…åˆ—ã®ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’å‡¦ç†
                  if (Array.isArray(child.material)) {
                    child.material.forEach(function(mat) {
                      if (mat.color) {
                        // è‰²ã‚’å¤‰æ›´
                        gsap.to(mat.color, {
                          r: col.r, g: col.g, b: col.b,
                          duration: 0.6, ease: 'power2.out'
                        });
                        
                        if (mat.metalness !== undefined) {
                          gsap.to(mat, {
                            metalness, roughness,
                            duration: 0.6, ease: 'power2.out'
                          });
                        }
                      }
                    });
                  } 
                  // å˜ä¸€ãƒãƒ†ãƒªã‚¢ãƒ«ã®å ´åˆ
                  else if (child.material.color) {
                    gsap.to(child.material.color, {
                      r: col.r, g: col.g, b: col.b,
                      duration: 0.6, ease: 'power2.out'
                    });
                    
                    if (child.material.metalness !== undefined) {
                      gsap.to(child.material, {
                        metalness, roughness,
                        duration: 0.6, ease: 'power2.out'
                      });
                    }
                  }
                }
              });
            }
            // å˜ä¸€ãƒ¡ãƒƒã‚·ãƒ¥ã®å ´åˆï¼ˆSTLãªã©ï¼‰
            else if (ringMesh.material && ringMesh.material.color) {
              gsap.to(ringMesh.material.color, {
                r: col.r, g: col.g, b: col.b,
                duration: 0.6, ease: 'power2.out'
              });
              
              let metalness = 0.9, roughness = 0.1;
              if (c === '#FFD700') {
                metalness = 0.95; roughness = 0.05;
              } else if (c === '#ffffff') {
                metalness = 0.7; roughness = 0.2;
              } else if (c === '#1d1d1d') {
                metalness = 0.8; roughness = 0.15;
              } else if (c === '#ffb6c1') {
                metalness = 0.85; roughness = 0.1;
              }
              
              gsap.to(ringMesh.material, {
                metalness, roughness,
                duration: 0.6, ease: 'power2.out'
              });
            }
          }
        } catch (error) {
          log(1, 'è‰²å¤‰æ›´ã‚¨ãƒ©ãƒ¼', error);
        }
      };
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
      btn.addEventListener('click', changeColor);
      btn.addEventListener('touchstart', changeColor, { passive: false });
      
      swatches.appendChild(btn);
    });
  } catch (error) {
    log(1, 'ã‚«ãƒ©ãƒ¼ã‚¹ã‚¦ã‚©ãƒƒãƒä½œæˆã‚¨ãƒ©ãƒ¼', error);
  }
}

function setupEventListeners() {
  try {
    // ãƒã‚¦ã‚¹ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆ
    document.addEventListener('mousemove', onMouseMove);
    
    // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
    document.addEventListener('mousedown', onMouseDown);
    document.addEventListener('mouseup', onMouseUp);
    document.addEventListener('mouseleave', onMouseUp);
    
    // ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ºãƒ¼ãƒ 
    document.addEventListener('wheel', onMouseWheel, { passive: false });
    
    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
    document.addEventListener('touchstart', onTouchStart, { passive: false });
    document.addEventListener('touchmove', onTouchMove, { passive: false });
    document.addEventListener('touchend', onTouchEnd);
    
    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    const resetButton = document.getElementById('reset-view');
    if (resetButton) {
      const resetHandler = function(e) {
        if (e.type === 'touchstart') e.preventDefault();
        
        // ã‚«ãƒ¡ãƒ©ä½ç½®ã¯å…ƒã®æ–œã‚ä¸Šã®ä½ç½®ã«æˆ»ã™
        gsap.to(camera.position, {
          x: 0, 
          y: CAMERA_HEIGHT, 
          z: CAMERA_DISTANCE,
          duration: 1.0, 
          ease: 'power2.out',
          onUpdate: function() {
            camera.lookAt(0, RING_HEIGHT, 0);
          }
        });
        
        if (ringMesh) {
          // ãƒªãƒ³ã‚°ãŒæ°´å¹³ã«ãªã‚‹å›è»¢ã«è¨­å®š
          const initialRotation = ringMesh.traverse ? 
            { x: Math.PI/2, y: Math.PI, z: 0 } :  // FBXãƒ¢ãƒ‡ãƒ«
            { x: Math.PI/2, y: 0, z: 0 };         // STLãƒ¢ãƒ‡ãƒ«
            
          gsap.to(ringMesh.rotation, {
            x: initialRotation.x,
            y: initialRotation.y,
            z: initialRotation.z,
            duration: 1.0, 
            ease: 'power2.out'
          });
        }
      };
      resetButton.addEventListener('click', resetHandler);
      resetButton.addEventListener('touchstart', resetHandler, { passive: false });
    }
    
    // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©
    window.addEventListener('resize', onResize);
  } catch (error) {
    log(1, 'ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', error);
  }
}

// script.js - ãƒ‘ãƒ¼ãƒˆ6: ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒæ“ä½œ (å›è»¢ä¿®æ­£ãƒ»ãƒ”ãƒ³ãƒå¼·åŒ–ç‰ˆ)
function onMouseMove(event) {
  try {
    // ãƒã‚¦ã‚¹åº§æ¨™ã®æ­£è¦åŒ–
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    
    checkRingHover();
    
    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®å›è»¢å‡¦ç†
    if (isDragging && ringMesh) {
      const deltaX = event.clientX - previousMousePosition.x;
      const deltaY = event.clientY - previousMousePosition.y;
      
      const rotationSpeed = 0.01;
      
      // å›è»¢ã‚’é©ç”¨ (ãƒã‚¤ãƒŠã‚¹è¨˜å·ã‚’å¤–ã—ã¦æ­£ã—ã„æ–¹å‘ã«å›è»¢ã™ã‚‹ã‚ˆã†ä¿®æ­£)
      if (ringMesh.traverse) {
        // FBXãƒ¢ãƒ‡ãƒ«ã®å ´åˆã€å›è»¢è»¸ã‚’èª¿æ•´
        ringMesh.rotation.z += deltaX * rotationSpeed; // ãƒã‚¤ãƒŠã‚¹è¨˜å·ã‚’å¤–ã™
        ringMesh.rotation.x += deltaY * rotationSpeed; // ä¸Šä¸‹ã¯åŒã˜
      } else {
        // STLãƒ¢ãƒ‡ãƒ«ã®å ´åˆ
        ringMesh.rotation.y += deltaX * rotationSpeed; // ãƒã‚¤ãƒŠã‚¹è¨˜å·ã‚’å¤–ã™
        ringMesh.rotation.x += deltaY * rotationSpeed; // ä¸Šä¸‹ã¯åŒã˜
      }
      
      // ãƒã‚¦ã‚¹ä½ç½®ã‚’æ›´æ–°
      previousMousePosition.x = event.clientX;
      previousMousePosition.y = event.clientY;
    }
  } catch (error) {
    log(1, 'ãƒã‚¦ã‚¹ç§»å‹•å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
  }
}

// ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã®ã‚ºãƒ¼ãƒ 
function onMouseWheel(event) {
  event.preventDefault();
  
  // ãƒ›ã‚¤ãƒ¼ãƒ«ã®æ–¹å‘ã‚’åˆ¤å®šï¼ˆãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§å¯¾å¿œï¼‰
  const delta = Math.max(-1, Math.min(1, (event.wheelDelta || -event.detail || -event.deltaY)));
  const zoomSpeed = 10;
  
  // ã‚«ãƒ¡ãƒ©ä½ç½®ã®æ›´æ–°
  gsap.to(camera.position, {
    z: Math.max(50, Math.min(200, camera.position.z - delta * zoomSpeed)),
    duration: 0.2,
    ease: 'power1.out'
  });
}

function checkRingHover() {
  try {
    if (!ringMesh) return;
    
    raycaster.setFromCamera(mouse, camera);
    
    // FBXãƒ¢ãƒ‡ãƒ«ã®å ´åˆã€å­è¦ç´ ã‚’å«ã‚ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ã‚¯ãƒˆæ¤œå‡º
    let intersects = [];
    if (ringMesh.traverse) {
      const meshes = [];
      ringMesh.traverse(function(child) {
        if (child.isMesh) {
          meshes.push(child);
        }
      });
      intersects = raycaster.intersectObjects(meshes);
    } else {
      intersects = raycaster.intersectObject(ringMesh);
    }
    
    if (intersects.length > 0) {
      if (!isRingHovered) {
        isRingHovered = true;
        document.body.style.cursor = 'grab';
        canvasElement.classList.add('can-rotate');
      }
    } else {
      if (isRingHovered && !isDragging) {
        isRingHovered = false;
        document.body.style.cursor = 'default';
        canvasElement.classList.remove('can-rotate');
      }
    }
  } catch (error) {
    log(1, 'ãƒªãƒ³ã‚°ãƒ›ãƒãƒ¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼', error);
  }
}

function onMouseDown(event) {
  try {
    if (!ringMesh) return;
    if (event.button !== 0) return;
    
    raycaster.setFromCamera(mouse, camera);
    
    // FBXãƒ¢ãƒ‡ãƒ«ã®å ´åˆã€å­è¦ç´ ã‚’å«ã‚ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ã‚¯ãƒˆæ¤œå‡º
    let intersects = [];
    if (ringMesh.traverse) {
      const meshes = [];
      ringMesh.traverse(function(child) {
        if (child.isMesh) {
          meshes.push(child);
        }
      });
      intersects = raycaster.intersectObjects(meshes);
    } else {
      intersects = raycaster.intersectObject(ringMesh);
    }
    
    if (intersects.length > 0) {
      isDragging = true;
      canvasElement.classList.add('rotating');
      document.body.style.cursor = 'grabbing';
      
      previousMousePosition.x = event.clientX;
      previousMousePosition.y = event.clientY;
      
      event.preventDefault();
    }
  } catch (error) {
    log(1, 'ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
  }
}

function onMouseUp() {
  try {
    if (isDragging) {
      isDragging = false;
      canvasElement.classList.remove('rotating');
      document.body.style.cursor = isRingHovered ? 'grab' : 'default';
    }
  } catch (error) {
    log(1, 'ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
  }
}

// ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ç”¨ã®å¤‰æ•°
let initialPinchDistance = 0;

// ã‚¿ãƒƒãƒé–‹å§‹æ™‚ã®å‡¦ç†
function onTouchStart(event) {
  try {
    if (!ringMesh) return;
    
    if (event.target.closest('.controls-container')) {
      return; // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã®ã‚¿ãƒƒãƒã¯ã‚¹ã‚­ãƒƒãƒ—
    }
    
    // è¤‡æ•°ã®ã‚¿ãƒƒãƒãŒã‚ã‚‹å ´åˆï¼ˆãƒ”ãƒ³ãƒæ“ä½œï¼‰
    if (event.touches.length === 2) {
      // 2æœ¬æŒ‡ã®ãƒ”ãƒ³ãƒæ“ä½œã®åˆæœŸè·é›¢ã‚’è¨˜éŒ²
      const dx = event.touches[0].clientX - event.touches[1].clientX;
      const dy = event.touches[0].clientY - event.touches[1].clientY;
      initialPinchDistance = Math.sqrt(dx * dx + dy * dy);
      event.preventDefault();
      return;
    }
    
    if (event.touches.length === 1) {
      const touch = event.touches[0];
      
      // ã‚¿ãƒƒãƒä½ç½®ã‚’ãƒã‚¦ã‚¹åº§æ¨™ã«å¤‰æ›
      mouse.x = (touch.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(touch.clientY / window.innerHeight) * 2 + 1;
      
      raycaster.setFromCamera(mouse, camera);
      
      // FBXãƒ¢ãƒ‡ãƒ«ã®å ´åˆã€å­è¦ç´ ã‚’å«ã‚ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ã‚¯ãƒˆæ¤œå‡º
      let intersects = [];
      if (ringMesh.traverse) {
        const meshes = [];
        ringMesh.traverse(function(child) {
          if (child.isMesh) {
            meshes.push(child);
          }
        });
        intersects = raycaster.intersectObjects(meshes);
      } else {
        intersects = raycaster.intersectObject(ringMesh);
      }
      
      if (intersects.length > 0) {
        isDragging = true;
        canvasElement.classList.add('rotating');
        
        previousMousePosition.x = touch.clientX;
        previousMousePosition.y = touch.clientY;
        
        event.preventDefault();
      }
    }
  } catch (error) {
    log(1, 'ã‚¿ãƒƒãƒã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
  }
}

// ã‚¿ãƒƒãƒç§»å‹•æ™‚ã®å‡¦ç† (ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ å¼·åŒ–ç‰ˆ)
function onTouchMove(event) {
  try {
    // ãƒ”ãƒ³ãƒæ“ä½œï¼ˆã‚ºãƒ¼ãƒ ï¼‰
    if (event.touches.length === 2) {
      event.preventDefault();
      
      // ç¾åœ¨ã®2æœ¬æŒ‡ã®è·é›¢ã‚’è¨ˆç®—
      const dx = event.touches[0].clientX - event.touches[1].clientX;
      const dy = event.touches[0].clientY - event.touches[1].clientY;
      const currentDistance = Math.sqrt(dx * dx + dy * dy);
      
      // è·é›¢ã®å¤‰åŒ–ã‚’è¨ˆç®—
      const pinchDelta = currentDistance - initialPinchDistance;
      const zoomSpeed = 0.5;
      
      // ã‚ˆã‚Šæ»‘ã‚‰ã‹ãªã‚ºãƒ¼ãƒ å‡¦ç†
      gsap.to(camera.position, {
        z: Math.max(50, Math.min(200, camera.position.z - pinchDelta * zoomSpeed)),
        duration: 0.2,
        ease: 'power1.out'
      });
      
      // æ¬¡ã®æ¯”è¼ƒã®ãŸã‚ã«ç¾åœ¨ã®è·é›¢ã‚’ä¿å­˜
      initialPinchDistance = currentDistance;
      return;
    }
    
    if (isDragging && ringMesh && event.touches.length === 1) {
      event.preventDefault();
      
      const touch = event.touches[0];
      const deltaX = touch.clientX - previousMousePosition.x;
      const deltaY = touch.clientY - previousMousePosition.y;
      
      // å›è»¢é€Ÿåº¦èª¿æ•´
      const rotationSpeed = 0.01;
      
      // ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå›è»¢å‡¦ç† (ãƒã‚¤ãƒŠã‚¹è¨˜å·ã‚’å¤–ã—ã¦æ­£ã—ã„æ–¹å‘ã«å›è»¢ã™ã‚‹ã‚ˆã†ä¿®æ­£)
      if (ringMesh.traverse) {
        // FBXãƒ¢ãƒ‡ãƒ«ã®å ´åˆã€å›è»¢è»¸ã‚’èª¿æ•´
        ringMesh.rotation.z += deltaX * rotationSpeed; // ãƒã‚¤ãƒŠã‚¹è¨˜å·ã‚’å¤–ã™
        ringMesh.rotation.x += deltaY * rotationSpeed; // ä¸Šä¸‹ã¯åŒã˜
      } else {
        // STLãƒ¢ãƒ‡ãƒ«ã®å ´åˆ
        ringMesh.rotation.y += deltaX * rotationSpeed; // ãƒã‚¤ãƒŠã‚¹è¨˜å·ã‚’å¤–ã™
        ringMesh.rotation.x += deltaY * rotationSpeed; // ä¸Šä¸‹ã¯åŒã˜
      }
      
      // ã‚¿ãƒƒãƒä½ç½®ã‚’æ›´æ–°
      previousMousePosition.x = touch.clientX;
      previousMousePosition.y = touch.clientY;
    }
  } catch (error) {
    log(1, 'ã‚¿ãƒƒãƒãƒ ãƒ¼ãƒ–å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
  }
}

function onTouchEnd() {
  try {
    if (isDragging) {
      isDragging = false;
      canvasElement.classList.remove('rotating');
    }
  } catch (error) {
    log(1, 'ã‚¿ãƒƒãƒã‚¨ãƒ³ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
  }
}

function onResize() {
  try {
    // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªå€¤ã‚’å†å–å¾—
    const responsiveValues = getResponsiveValues();
    RING_HEIGHT = responsiveValues.RING_HEIGHT;
    CAMERA_HEIGHT = responsiveValues.CAMERA_HEIGHT;
    CAMERA_DISTANCE = responsiveValues.CAMERA_DISTANCE;
    
    // ã‚«ãƒ¡ãƒ©è¨­å®šã‚’æ›´æ–°
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    
    // ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚«ãƒ¡ãƒ©ä½ç½®ã‚‚æ›´æ–°
camera.position.y = CAMERA_HEIGHT * 2.5;
camera.position.z = 0; // Zä½ç½®ã‚‚æ›´æ–°
camera.lookAt(0, RING_HEIGHT, 0);
    
    // ãƒªãƒ³ã‚°ã®ä½ç½®ã‚‚æ›´æ–°ï¼ˆã‚‚ã—å­˜åœ¨ã™ã‚Œã°ï¼‰
    if (ringMesh) {
      ringMesh.position.y = RING_HEIGHT;
    }
    
    if (renderer && composer) {
      renderer.setSize(window.innerWidth, window.innerHeight);
      composer.setSize(window.innerWidth, window.innerHeight);
    }
  } catch (error) {
    log(1, 'ãƒªã‚µã‚¤ã‚ºå‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
  }
}

// script.js - ãƒ‘ãƒ¼ãƒˆ8: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ã¨åˆæœŸåŒ–
function animate() {
  try {
    requestAnimationFrame(animate);
    
    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    if (composer) {
      composer.render();
    }
  } catch (error) {
    log(1, 'ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
  }
}

// åˆæœŸåŒ–ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
document.addEventListener('DOMContentLoaded', function() {
  try {
    // GSAPã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
    if (typeof gsap === 'undefined') {
      console.warn('GSAPãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœãŒåˆ¶é™ã•ã‚Œã¾ã™ã€‚');
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ã®ç°¡æ˜“GSAPäº’æ›ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      window.gsap = {
        to: function(target, params) {
          if (params.duration && params.onUpdate) {
            const steps = Math.ceil(params.duration * 60); // 60fpsæƒ³å®š
            const interval = params.duration * 1000 / steps;
            let step = 0;
            
            const timer = setInterval(function() {
              step++;
              if (step >= steps) {
                clearInterval(timer);
                // æœ€çµ‚å€¤ã‚’è¨­å®š
                for (const key in params) {
                  if (key !== 'duration' && key !== 'ease' && key !== 'onUpdate') {
                    target[key] = params[key];
                  }
                }
                params.onUpdate && params.onUpdate();
              } else {
                // ç·šå½¢è£œé–“ã§å€¤ã‚’æ›´æ–°
                const progress = step / steps;
                for (const key in params) {
                  if (key !== 'duration' && key !== 'ease' && key !== 'onUpdate') {
                    target[key] += (params[key] - target[key]) / (steps - step + 1);
                  }
                }
                params.onUpdate && params.onUpdate();
              }
            }, interval);
          } else {
            // å˜ç´”ã«å€¤ã‚’è¨­å®š
            for (const key in params) {
              if (key !== 'duration' && key !== 'ease') {
                target[key] = params[key];
              }
            }
          }
        },
        from: function(target, params) {
          // fromã®å®Ÿè£…ï¼ˆéå¸¸ã«ç°¡æ˜“çš„ï¼‰
          const originalValues = {};
          for (const key in params) {
            if (key !== 'duration' && key !== 'ease') {
              originalValues[key] = target[key];
              target[key] = params[key];
            }
          }
          this.to(target, { ...params, ...originalValues });
        }
      };
    }
    
    init();
    animate();
    
    // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ã€20ç§’å¾Œã«ã‚‚ã¾ã ãƒ­ãƒ¼ãƒ‰ä¸­ãªã‚‰å¼·åˆ¶çš„ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
    setTimeout(function() {
      if (document.querySelector('.loading-screen') && 
          !document.querySelector('.loading-screen.hidden')) {
        log(1, "ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å¼·åˆ¶è¡¨ç¤º");
        hideLoading();
        createPlaceholderRing();
      }
    }, 20000);
    
  } catch (error) {
    log(1, "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
    hideLoading();
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
    const errorMsg = document.createElement('div');
    errorMsg.style.position = 'fixed';
    errorMsg.style.top = '50%';
    errorMsg.style.left = '50%';
    errorMsg.style.transform = 'translate(-50%, -50%)';
    errorMsg.style.backgroundColor = 'rgba(255,255,255,0.9)';
    errorMsg.style.padding = '20px';
    errorMsg.style.borderRadius = '10px';
    errorMsg.style.boxShadow = '0 4px 20px rgba(0,0,0,0.1)';
    errorMsg.style.zIndex = '1000';
    errorMsg.textContent = 'è¡¨ç¤ºã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
    document.body.appendChild(errorMsg);
  }
});

// GSAPç”¨ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
if (typeof gsap === 'undefined') {
  console.warn('GSAPã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„: https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.3/gsap.min.js');
}
